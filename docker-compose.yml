services:
  hubble-server:
    build: .
    container_name: hubble-server 
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - hubble-projects:/projects
      # Mount Docker volumes so hubble-server can create containers that use them
      - hubble-traefik-data:/var/lib/hubble/traefik
      - hubble-registry-data:/var/lib/hubble/registry
      - hubble-registry-auth:/var/lib/hubble/registry-auth
    environment:
      - LOG_LEVEL=info
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - ADMIN_USERNAME=${ADMIN_USERNAME}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - ACCESS_TOKEN_DURATION=${ACCESS_TOKEN_DURATION:-5m}
      - REFRESH_TOKEN_DURATION=${REFRESH_TOKEN_DURATION:-168h}
      - PROJECTS_ROOT_PATH=/projects
      - HUBBLE_DOMAIN=${HUBBLE_DOMAIN}
      - HUBBLE_TRAEFIK_ENABLED=${HUBBLE_TRAEFIK_ENABLED:-false}
      - HUBBLE_TRAEFIK_EMAIL=${HUBBLE_TRAEFIK_EMAIL}
      - HUBBLE_TRAEFIK_DASHBOARD=${HUBBLE_TRAEFIK_DASHBOARD:-false}
      - HUBBLE_TRAEFIK_DASHBOARD_AUTH=${HUBBLE_TRAEFIK_DASHBOARD_AUTH}
      - HUBBLE_REGISTRY_ENABLED=${HUBBLE_REGISTRY_ENABLED:-true}
      - HUBBLE_REGISTRY_DELETE_ENABLED=${HUBBLE_REGISTRY_DELETE_ENABLED:-true}
      - HUBBLE_REGISTRY_STORAGE=/var/lib/hubble/registry
    networks:
      - hubble
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hubble-api.rule=Host(`hubble.${HUBBLE_DOMAIN:-localhost}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.hubble-api.entrypoints=websecure"
      - "traefik.http.routers.hubble-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.hubble-api.priority=2"
      - "traefik.http.services.hubble-api.loadbalancer.server.port=5000"
      - "traefik.http.middlewares.hubble-api-stripprefix.stripprefix.prefixes=/api"
      - "traefik.http.routers.hubble-api.middlewares=hubble-api-stripprefix"

  hubble-web:
    build: ./web
    container_name: hubble-web
    restart: unless-stopped
    networks:
      - hubble
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hubble-web.rule=Host(`hubble.${HUBBLE_DOMAIN:-localhost}`)"
      - "traefik.http.routers.hubble-web.entrypoints=websecure"
      - "traefik.http.routers.hubble-web.tls.certresolver=letsencrypt"
      - "traefik.http.routers.hubble-web.priority=1"
      - "traefik.http.services.hubble-web.loadbalancer.server.port=80"

volumes:
  # Docker-managed volumes - no permission issues!
  hubble-traefik-data:
    name: hubble-traefik-data
    driver: local
  hubble-registry-data:
    name: hubble-registry-data
    driver: local
  hubble-registry-auth:
    name: hubble-registry-auth
    driver: local
  hubble-projects:
    name: hubble-projects
    driver: local

networks:
  hubble:
    name: hubble
    driver: bridge
    labels:
      com.hubble.managed: "true"
      com.hubble.network: "platform"
