services:
  hubble-server:
    build: .
    container_name: hubble-server 
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - hubble-projects:/projects
      # Mount Docker volumes so hubble-server can create containers that use them
      - hubble-traefik-data:/var/lib/hubble/traefik
      - hubble-registry-data:/var/lib/hubble/registry
      - hubble-registry-auth:/var/lib/hubble/registry-auth
    environment:
      - LOG_LEVEL=info
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - ADMIN_USERNAME=${ADMIN_USERNAME}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - ACCESS_TOKEN_DURATION=${ACCESS_TOKEN_DURATION:-5m}
      - REFRESH_TOKEN_DURATION=${REFRESH_TOKEN_DURATION:-168h}
      - PROJECTS_ROOT_PATH=/projects
      - HUBBLE_DOMAIN=${HUBBLE_DOMAIN}
      - HUBBLE_TRAEFIK_ENABLED=${HUBBLE_TRAEFIK_ENABLED:-false}
      - HUBBLE_TRAEFIK_EMAIL=${HUBBLE_TRAEFIK_EMAIL}
      - HUBBLE_REGISTRY_ENABLED=${HUBBLE_REGISTRY_ENABLED:-true}
      - HUBBLE_REGISTRY_DELETE_ENABLED=${HUBBLE_REGISTRY_DELETE_ENABLED:-true}
      - HUBBLE_REGISTRY_STORAGE=/var/lib/hubble/registry
      - HUBBLE_DISABLE_PLATFORM_FALLBACK=${HUBBLE_DISABLE_PLATFORM_FALLBACK:-false}
    networks:
      - hubble
    labels:
      - "traefik.enable=true"
      # Shared configuration
      - "traefik.http.services.hubble-api.loadbalancer.server.port=5000"
      - "traefik.http.middlewares.hubble-api-stripprefix.stripprefix.prefixes=/api"
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.https-redirect.redirectscheme.permanent=true"
      # HTTP router - conditional redirect based on HUBBLE_DOMAIN
      - "traefik.http.routers.hubble-api-http.rule=Host(`hubble.${HUBBLE_DOMAIN:-localhost}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.hubble-api-http.entrypoints=web"
      - "traefik.http.routers.hubble-api-http.priority=2"
      - "traefik.http.routers.hubble-api-http.middlewares=${HUBBLE_HTTPS_REDIRECT:-hubble-api-stripprefix}"
      # HTTPS router
      - "traefik.http.routers.hubble-api-secure.rule=Host(`hubble.${HUBBLE_DOMAIN:-localhost}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.hubble-api-secure.entrypoints=websecure"
      - "traefik.http.routers.hubble-api-secure.priority=2"
      - "traefik.http.routers.hubble-api-secure.tls=true"
      - "traefik.http.routers.hubble-api-secure.tls.certresolver=${HUBBLE_CERT_RESOLVER:-}"
      - "traefik.http.routers.hubble-api-secure.middlewares=hubble-api-stripprefix"

  hubble-web:
    build: ./web
    container_name: hubble-web
    restart: unless-stopped
    networks:
      - hubble
    labels:
      - "traefik.enable=true"
      # Shared configuration
      - "traefik.http.services.hubble-web.loadbalancer.server.port=80"
      # HTTP router - conditional redirect based on HUBBLE_DOMAIN
      - "traefik.http.routers.hubble-web-http.rule=Host(`hubble.${HUBBLE_DOMAIN:-localhost}`)"
      - "traefik.http.routers.hubble-web-http.entrypoints=web"
      - "traefik.http.routers.hubble-web-http.priority=1"
      - "traefik.http.routers.hubble-web-http.middlewares=${HUBBLE_HTTPS_REDIRECT:-}"
      # HTTPS router
      - "traefik.http.routers.hubble-web-secure.rule=Host(`hubble.${HUBBLE_DOMAIN:-localhost}`)"
      - "traefik.http.routers.hubble-web-secure.entrypoints=websecure"
      - "traefik.http.routers.hubble-web-secure.priority=1"
      - "traefik.http.routers.hubble-web-secure.tls=true"
      - "traefik.http.routers.hubble-web-secure.tls.certresolver=${HUBBLE_CERT_RESOLVER:-}"

  hubble-traefik:
    image: traefik:v3.6
    container_name: hubble-traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    command:
      - --providers.docker=true
      - --providers.docker.network=hubble
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.letsencrypt.acme.email=${HUBBLE_TRAEFIK_EMAIL:-noreply@localhost}
      - --certificatesresolvers.letsencrypt.acme.storage=/data/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
      # Logging
      - --log.level=INFO
      - --accesslog=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - hubble-traefik-data:/data
    networks:
      - hubble
    labels:
      com.hubble.managed: "true"
      com.hubble.service: "traefik"

  registry-init:
    image: httpd:alpine
    container_name: registry-init
    command: >
      sh -c "htpasswd -Bbn ${ADMIN_USERNAME} ${ADMIN_PASSWORD} > /auth/htpasswd && 
             chmod 644 /auth/htpasswd && 
             echo 'âœ“ Registry auth configured'"
    volumes:
      - hubble-registry-auth:/auth

  hubble-registry:
    image: registry:2
    container_name: hubble-registry
    restart: unless-stopped
    depends_on:
      registry-init:
        condition: service_completed_successfully
    environment:
      - REGISTRY_AUTH=htpasswd
      - REGISTRY_AUTH_HTPASSWD_REALM=Hubble Registry
      - REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd
      - REGISTRY_STORAGE_DELETE_ENABLED=${HUBBLE_REGISTRY_DELETE_ENABLED:-true}
    volumes:
      - hubble-registry-data:/var/lib/registry
      - hubble-registry-auth:/auth
    networks:
      - hubble
    labels:
      com.hubble.managed: "true"
      com.hubble.service: "registry"
      traefik.enable: "true"
      # Shared configuration
      traefik.http.services.registry.loadbalancer.server.port: "5000"
      # HTTP router - conditional redirect based on HUBBLE_DOMAIN
      traefik.http.routers.registry-http.rule: "Host(`registry.${HUBBLE_DOMAIN:-localhost}`)"
      traefik.http.routers.registry-http.entrypoints: "web"
      traefik.http.routers.registry-http.middlewares: "${HUBBLE_HTTPS_REDIRECT:-}"
      # HTTPS router
      traefik.http.routers.registry-secure.rule: "Host(`registry.${HUBBLE_DOMAIN:-localhost}`)"
      traefik.http.routers.registry-secure.entrypoints: "websecure"
      traefik.http.routers.registry-secure.tls: "true"
      traefik.http.routers.registry-secure.tls.certresolver: "${HUBBLE_CERT_RESOLVER:-}"

volumes:
  # Docker-managed volumes - no permission issues!
  hubble-traefik-data:
    name: hubble-traefik-data
    driver: local
  hubble-registry-data:
    name: hubble-registry-data
    driver: local
  hubble-registry-auth:
    name: hubble-registry-auth
    driver: local
  hubble-projects:
    name: hubble-projects
    driver: local

networks:
  hubble:
    name: hubble
    driver: bridge
    labels:
      com.hubble.managed: "true"
      com.hubble.network: "platform"
